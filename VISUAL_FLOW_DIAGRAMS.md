# UBO Trace Engine - Visual Flow Diagrams

## 1. Complete System Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Frontend (React)                             â”‚
â”‚              /Users/.../ubo-trace-engine-frontend/                   â”‚
â”‚  - UBO Search Form                                                   â”‚
â”‚  - Results Display                                                   â”‚
â”‚  - Domain Analysis UI                                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚ HTTP/REST API
                               â”‚ POST /api/v1/trace
                               â”‚ GET /api/v1/trace/{id}/summary
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FastAPI Backend (Python)                          â”‚
â”‚                    /api/v1/* endpoints                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  API Layer (api/endpoints.py)                                 â”‚  â”‚
â”‚  â”‚  - POST /trace (create)                                       â”‚  â”‚
â”‚  â”‚  - POST /trace/{id}/execute (execute)                         â”‚  â”‚
â”‚  â”‚  - GET /trace/{id}/summary (get results)                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                         â”‚                                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Service Layer                                               â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚
â”‚  â”‚  â”‚  UBO Trace Service (orchestrates 4 stages)            â”‚ â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚
â”‚  â”‚         â”‚                  â”‚                  â”‚             â”‚  â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚  â”‚
â”‚  â”‚  â”‚ Lyzr        â”‚  â”‚ SearchAPI      â”‚  â”‚ Apollo          â”‚   â”‚  â”‚
â”‚  â”‚  â”‚ Service     â”‚  â”‚ Service       â”‚  â”‚ Service         â”‚   â”‚  â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚            â”‚                  â”‚                  â”‚                 â”‚
â”‚            â”‚                  â”‚                  â”‚                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                  â”‚                  â”‚
             â”‚                  â”‚                  â”‚
             â–¼                  â–¼                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  External Services                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  Lyzr AI         â”‚  â”‚  SearchAPI    â”‚  â”‚  Apollo.io       â”‚    â”‚
â”‚  â”‚  (Perplexity)   â”‚  â”‚  Google SERP  â”‚  â”‚  People Search   â”‚    â”‚
â”‚  â”‚  - 4 Stages      â”‚  â”‚  - Domain     â”‚  â”‚  - Enrichment    â”‚    â”‚
â”‚  â”‚  - Domain        â”‚  â”‚    Search     â”‚  â”‚  - Insights      â”‚    â”‚
â”‚  â”‚  - Confidence    â”‚  â”‚               â”‚  â”‚                  â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    MongoDB Database                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”         â”‚
â”‚  â”‚  ubo_traces collection  â”‚  â”‚  trace_results collection â”‚         â”‚
â”‚  â”‚  - trace_id (UUID)      â”‚  â”‚  - trace_id (FK)         â”‚         â”‚
â”‚  â”‚  - entity               â”‚  â”‚  - stage (1A/1B/2A/2B)  â”‚         â”‚
â”‚  â”‚  - ubo_name             â”‚  â”‚  - facts[]               â”‚         â”‚
â”‚  â”‚  - location             â”‚  â”‚  - summary               â”‚         â”‚
â”‚  â”‚  - status               â”‚  â”‚  - enrichment data       â”‚         â”‚
â”‚  â”‚  - created_at           â”‚  â”‚  - processing_time_ms     â”‚         â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 2. Multi-Stage Execution Flow

```
User Request
    â”‚
    â”œâ”€ Input: Entity, UBO Name (optional), Location, Domain (optional)
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 1: Create Trace                                               â”‚
â”‚  POST /api/v1/trace                                                 â”‚
â”‚  - Generate trace_id (UUID)                                          â”‚
â”‚  - Store in MongoDB (status: PENDING)                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 2: Execute Trace                                              â”‚
â”‚  POST /api/v1/trace/{trace_id}/execute                             â”‚
â”‚  - Update status: IN_PROGRESS                                        â”‚
â”‚  - Clear previous results                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STAGE 1A: Multi-Stage Perplexity Search Engine - 1A               â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  Agent: 68e8dd6c3e9645375cfcfd86                                    â”‚
â”‚  Purpose: Independent corporate-ownership investigator              â”‚
â”‚  Scope: All-time verified registry filings                           â”‚
â”‚  â”‚                                                                   â”‚
â”‚  â”œâ”€â†’ Call Lyzr Agent (Primary)                                     â”‚
â”‚  â”‚   â””â”€â†’ Perplexity Search                                           â”‚
â”‚  â”‚       â””â”€â†’ Parse Response: Facts, URLs, Summary                    â”‚
â”‚  â”‚                                                                   â”‚
â”‚  â”œâ”€â†’ Apollo Enrichment (Parallel)                                 â”‚
â”‚  â”‚   â”œâ”€â†’ Search People by Organization                               â”‚
â”‚  â”‚   â”œâ”€â†’ Filter by Titles/Domains/Locations                          â”‚
â”‚  â”‚   â””â”€â†’ Extract Key Insights                                         â”‚
â”‚  â”‚                                                                   â”‚
â”‚  â”œâ”€â†’ SearchAPI Domain Search (Parallel)                             â”‚
â”‚  â”‚   â”œâ”€â†’ Build Search Query                                          â”‚
â”‚  â”‚   â”œâ”€â†’ Call Google SERP API                                        â”‚
â”‚  â”‚   â””â”€â†’ Extract Domains (remove duplicates)                         â”‚
â”‚  â”‚                                                                   â”‚
â”‚  â””â”€â†’ Expert Domain Analysis (Parallel)                              â”‚
â”‚      â”œâ”€â†’ Collect Domains (Lyzr + SearchAPI)                         â”‚
â”‚      â”œâ”€â†’ Call Expert Agent                                           â”‚
â”‚      â””â”€â†’ Assign Confidence Scores & Rank                            â”‚
â”‚                                                                      â”‚
â”‚  â””â”€â†’ Save Stage Result to MongoDB                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚ (5-second delay)
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STAGE 1B: Direct Evidence (Time-Scoped)                            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  Agent: 68ec33428be660f19f91cf3e                                   â”‚
â”‚  Purpose: Time-filtered direct relationship search                  â”‚
â”‚  Scope: Jan 2023 - Present                                           â”‚
â”‚  â”‚                                                                   â”‚
â”‚  â”œâ”€â†’ Same parallel enrichment flow as Stage 1A                      â”‚
â”‚  â””â”€â†’ Save Stage Result to MongoDB                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚ (5-second delay)
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STAGE 2A: Indirect Links (Structural)                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  Agent: 68ec3536de8385f5b4326896                                    â”‚
â”‚  Purpose: Investigate layered ownership structures                  â”‚
â”‚  Focus: Subsidiaries, holding firms, trusts, SPVs                    â”‚
â”‚  â”‚                                                                   â”‚
â”‚  â”œâ”€â†’ Same parallel enrichment flow as Stage 1A                      â”‚
â”‚  â””â”€â†’ Save Stage Result to MongoDB                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚ (5-second delay)
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  STAGE 2B: Indirect Links (Recent 2 years)                         â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  Agent: 68ec36368d106b3b3abba21b                                    â”‚
â”‚  Purpose: Recent indirect ownership/control links                    â”‚
â”‚  Scope: Jan 2023 - Present                                           â”‚
â”‚  â”‚                                                                   â”‚
â”‚  â”œâ”€â†’ Same parallel enrichment flow as Stage 1A                      â”‚
â”‚  â””â”€â†’ Save Stage Result to MongoDB                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 3: Aggregate Results                                          â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  â”œâ”€â†’ Combine all stage results                                      â”‚
â”‚  â”œâ”€â†’ Remove duplicates (URLs, facts, domains)                        â”‚
â”‚  â”œâ”€â†’ Calculate statistics:                                           â”‚
â”‚  â”‚   - Total URLs                                                    â”‚
â”‚  â”‚   - Total direct facts                                            â”‚
â”‚  â”‚   - Total indirect facts                                          â”‚
â”‚  â””â”€â†’ Determine connection status:                                     â”‚
â”‚      - DIRECT CONNECTION (if Stage 1A or 1B found direct evidence)  â”‚
â”‚      - INDIRECT CONNECTION ONLY (if only Stage 2A or 2B found)      â”‚
â”‚      - NO CONNECTION (if no evidence found)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 4: Generate Summary                                           â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  â”œâ”€â†’ Create TraceSummary object                                      â”‚
â”‚  â”œâ”€â†’ Update trace status: COMPLETED                                   â”‚
â”‚  â””â”€â†’ Store summary in MongoDB                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Step 5: Return Summary                                             â”‚
â”‚  GET /api/v1/trace/{trace_id}/summary                              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  Response:                                                           â”‚
â”‚  - trace_id                                                          â”‚
â”‚  - entity, ubo_name, location                                        â”‚
â”‚  - connection_status (DIRECT/INDIRECT/NO CONNECTION)                â”‚
â”‚  - total_urls, total_direct_facts, total_indirect_facts             â”‚
â”‚  - stage_results[] (detailed results per stage)                     â”‚
â”‚  - total_processing_time_ms                                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 3. Parallel Enrichment Flow (Per Stage)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Stage Execution (1A, 1B, 2A, or 2B)                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
               â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
               â”‚               â”‚               â”‚
               â–¼               â–¼               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PRIMARY:            â”‚  â”‚  PARALLEL 1:         â”‚  â”‚  PARALLEL 2:         â”‚
â”‚  Lyzr Agent Call    â”‚  â”‚  Apollo Enrichment   â”‚  â”‚  SearchAPI Domain    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚  â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  â”‚                   â”‚  â”‚  â”‚                   â”‚  â”‚  â”‚                   â”‚
â”‚  â”œâ”€â†’ Build Message   â”‚  â”‚  â”œâ”€â†’ Search People   â”‚  â”‚  â”œâ”€â†’ Build Query     â”‚
â”‚  â”œâ”€â†’ Call Lyzr API   â”‚  â”‚  â”œâ”€â†’ Filter Results  â”‚  â”‚  â”œâ”€â†’ Call Google     â”‚
â”‚  â”œâ”€â†’ Parse Response  â”‚  â”‚  â”œâ”€â†’ Extract Insightsâ”‚  â”‚  â”œâ”€â†’ Extract Domains â”‚
â”‚  â””â”€â†’ Extract Facts   â”‚  â”‚  â””â”€â†’ Store Data      â”‚  â”‚  â””â”€â†’ Store Data      â”‚
â”‚                      â”‚  â”‚                      â”‚  â”‚                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  PARALLEL 3:         â”‚
                    â”‚  Expert Domain       â”‚
                    â”‚  Analysis            â”‚
                    â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
                    â”‚  â”‚                   â”‚
                    â”‚  â”œâ”€â†’ Collect Domains â”‚
                    â”‚  â”œâ”€â†’ Call Expert     â”‚
                    â”‚  â”œâ”€â†’ Assign Scores   â”‚
                    â”‚  â””â”€â†’ Rank Domains    â”‚
                    â”‚                      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                               â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Aggregate Stage Results                                            â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚  â”œâ”€â†’ Combine Lyzr facts + Apollo insights + SearchAPI domains      â”‚
â”‚  â”œâ”€â†’ Add Expert domain analysis                                     â”‚
â”‚  â””â”€â†’ Save complete stage result to MongoDB                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. Data Flow Architecture

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Request Flow                                                        â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                      â”‚
â”‚  User Input                                                          â”‚
â”‚  â”œâ”€â†’ entity: "Company Name"                                         â”‚
â”‚  â”œâ”€â†’ ubo_name: "Person Name" (optional)                             â”‚
â”‚  â”œâ”€â†’ location: "UAE" (optional)                                     â”‚
â”‚  â””â”€â†’ domain_name: "example.com" (optional)                          â”‚
â”‚                                                                      â”‚
â”‚  â””â”€â†’ POST /api/v1/trace                                              â”‚
â”‚      â””â”€â†’ Create UBOTraceRequest                                      â”‚
â”‚          â””â”€â†’ Generate trace_id (UUID)                                â”‚
â”‚              â””â”€â†’ Store in MongoDB (status: PENDING)                 â”‚
â”‚                                                                      â”‚
â”‚  â””â”€â†’ POST /api/v1/trace/{trace_id}/execute                          â”‚
â”‚      â””â”€â†’ Update status: IN_PROGRESS                                 â”‚
â”‚          â””â”€â†’ Execute 4 stages sequentially                          â”‚
â”‚              â””â”€â†’ For each stage:                                     â”‚
â”‚                  â”œâ”€â†’ Call Lyzr Agent                                â”‚
â”‚                  â”œâ”€â†’ Apollo Enrichment (parallel)                    â”‚
â”‚                  â”œâ”€â†’ SearchAPI Domain Search (parallel)              â”‚
â”‚                  â””â”€â†’ Expert Domain Analysis (parallel)               â”‚
â”‚                      â””â”€â†’ Save stage result to MongoDB                 â”‚
â”‚                                                                      â”‚
â”‚  â””â”€â†’ Aggregate Results                                               â”‚
â”‚      â”œâ”€â†’ Combine all stage results                                   â”‚
â”‚      â”œâ”€â†’ Remove duplicates                                           â”‚
â”‚      â”œâ”€â†’ Calculate statistics                                        â”‚
â”‚      â””â”€â†’ Determine connection status                                 â”‚
â”‚          â””â”€â†’ Update trace status: COMPLETED                          â”‚
â”‚              â””â”€â†’ Store summary in MongoDB                            â”‚
â”‚                                                                      â”‚
â”‚  â””â”€â†’ GET /api/v1/trace/{trace_id}/summary                            â”‚
â”‚      â””â”€â†’ Retrieve from MongoDB                                       â”‚
â”‚          â””â”€â†’ Return TraceSummary response                            â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 5. Retry Logic Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Stage Execution with Retry Logic                                    â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                      â”‚
â”‚  Attempt 1                                                           â”‚
â”‚  â”œâ”€â†’ Call Lyzr Agent                                               â”‚
â”‚  â”œâ”€â†’ Parse Response                                                 â”‚
â”‚  â”œâ”€â†’ Check for Zero Results                                         â”‚
â”‚  â”‚   â”‚                                                               â”‚
â”‚  â”‚   â”œâ”€â†’ If Zero Results:                                           â”‚
â”‚  â”‚   â”‚   â””â”€â†’ Wait 5 seconds                                         â”‚
â”‚  â”‚   â”‚       â””â”€â†’ Retry (Attempt 2)                                   â”‚
â”‚  â”‚   â”‚                                                               â”‚
â”‚  â”‚   â””â”€â†’ If Results Found:                                          â”‚
â”‚  â”‚       â””â”€â†’ Continue with enrichments                               â”‚
â”‚  â”‚           â””â”€â†’ Save Stage Result                                   â”‚
â”‚  â”‚               â””â”€â†’ Proceed to Next Stage                            â”‚
â”‚  â”‚                                                                   â”‚
â”‚  â””â”€â†’ If API Call Failed:                                             â”‚
â”‚      â””â”€â†’ Wait 5 seconds                                               â”‚
â”‚          â””â”€â†’ Retry (Attempt 2)                                        â”‚
â”‚                                                                      â”‚
â”‚  Attempt 2 (if needed)                                               â”‚
â”‚  â”œâ”€â†’ Same flow as Attempt 1                                          â”‚
â”‚  â””â”€â†’ If Zero Results or Failed:                                      â”‚
â”‚      â””â”€â†’ Wait 5 seconds                                              â”‚
â”‚          â””â”€â†’ Retry (Attempt 3)                                        â”‚
â”‚                                                                      â”‚
â”‚  Attempt 3 (if needed)                                               â”‚
â”‚  â”œâ”€â†’ Same flow as Attempt 1                                          â”‚
â”‚  â””â”€â†’ If Zero Results or Failed:                                      â”‚
â”‚      â””â”€â†’ Wait 5 seconds                                              â”‚
â”‚          â””â”€â†’ Retry (Attempt 4)                                        â”‚
â”‚                                                                      â”‚
â”‚  Attempt 4 (Final)                                                    â”‚
â”‚  â”œâ”€â†’ Same flow as Attempt 1                                          â”‚
â”‚  â””â”€â†’ If Zero Results or Failed:                                      â”‚
â”‚      â””â”€â†’ Mark as Failed (or return zero results)                      â”‚
â”‚          â””â”€â†’ Proceed to Next Stage (don't block)                      â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. Connection Status Determination Logic

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Connection Status Determination                                     â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                      â”‚
â”‚  Stage Results Aggregation                                          â”‚
â”‚  â”œâ”€â†’ Collect all stage results                                       â”‚
â”‚  â”œâ”€â†’ Extract direct evidence (from Stage 1A and 1B)                 â”‚
â”‚  â”œâ”€â†’ Extract indirect evidence (from Stage 2A and 2B)               â”‚
â”‚  â””â”€â†’ Remove duplicates                                               â”‚
â”‚                                                                      â”‚
â”‚  Status Determination Logic                                          â”‚
â”‚  â”‚                                                                   â”‚
â”‚  â”œâ”€â†’ Check for Direct Evidence                                       â”‚
â”‚  â”‚   â”‚                                                               â”‚
â”‚  â”‚   â”œâ”€â†’ If has_direct_evidence == True:                             â”‚
â”‚  â”‚   â”‚   â””â”€â†’ connection_status = "DIRECT CONNECTION"                 â”‚
â”‚  â”‚   â”‚       â””â”€â†’ Return (priority: direct > indirect)               â”‚
â”‚  â”‚   â”‚                                                               â”‚
â”‚  â”‚   â””â”€â†’ If has_direct_evidence == False:                            â”‚
â”‚  â”‚       â””â”€â†’ Check for Indirect Evidence                             â”‚
â”‚  â”‚           â”‚                                                       â”‚
â”‚  â”‚           â”œâ”€â†’ If has_indirect_evidence == True:                   â”‚
â”‚  â”‚           â”‚   â””â”€â†’ connection_status = "INDIRECT CONNECTION ONLY"  â”‚
â”‚  â”‚           â”‚       â””â”€â†’ Return                                       â”‚
â”‚  â”‚           â”‚                                                       â”‚
â”‚  â”‚           â””â”€â†’ If has_indirect_evidence == False:                   â”‚
â”‚  â”‚               â””â”€â†’ connection_status = "NO CONNECTION"              â”‚
â”‚  â”‚                   â””â”€â†’ Return                                       â”‚
â”‚  â”‚                                                                   â”‚
â”‚  â””â”€â†’ Final Summary                                                   â”‚
â”‚      â”œâ”€â†’ connection_status: "DIRECT CONNECTION" |                      â”‚
â”‚      â”‚                      "INDIRECT CONNECTION ONLY" |              â”‚
â”‚      â”‚                      "NO CONNECTION"                           â”‚
â”‚      â”œâ”€â†’ total_direct_facts: count                                    â”‚
â”‚      â”œâ”€â†’ total_indirect_facts: count                                  â”‚
â”‚      â””â”€â†’ total_urls: unique count                                     â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 7. Domain Analysis Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Domain Analysis Flow                                                â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                      â”‚
â”‚  Input: company_name, ubo_name (optional), address                   â”‚
â”‚  â”‚                                                                   â”‚
â”‚  â”œâ”€â†’ Step 1: Domain Search Agent (68edec6f9bc72912ffb59215)         â”‚
â”‚  â”‚   â”œâ”€â†’ Analyze domain ownership                                    â”‚
â”‚  â”‚   â”œâ”€â†’ Examine registrant data                                     â”‚
â”‚  â”‚   â”œâ”€â†’ Identify corporate/personal links                            â”‚
â”‚  â”‚   â””â”€â†’ Surface relevant websites                                   â”‚
â”‚  â”‚       â””â”€â†’ Output: List of domains with summaries                  â”‚
â”‚  â”‚                                                                   â”‚
â”‚  â”œâ”€â†’ Step 2: SearchAPI Domain Search (Parallel)                      â”‚
â”‚  â”‚   â”œâ”€â†’ Build search query                                           â”‚
â”‚  â”‚   â”œâ”€â†’ Call Google SERP API                                         â”‚
â”‚  â”‚   â””â”€â†’ Extract domains (remove duplicates)                         â”‚
â”‚  â”‚       â””â”€â†’ Output: Ranked list of domains                          â”‚
â”‚  â”‚                                                                   â”‚
â”‚  â””â”€â†’ Step 3: Domain Confidence Score Agent (68f0ffd5a0dfaa3e0726523c)â”‚
â”‚      â”œâ”€â†’ Collect domains from Step 1 and Step 2                       â”‚
â”‚      â”œâ”€â†’ Evaluate each domain for relevance                           â”‚
â”‚      â”œâ”€â†’ Assign confidence score (0-100%)                            â”‚
â”‚      â”œâ”€â†’ Rank domains by credibility                                  â”‚
â”‚      â””â”€â†’ Provide reasoning for each score                            â”‚
â”‚          â””â”€â†’ Output: Ranked domains with confidence scores          â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 8. Error Handling Flow

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Error Handling Flow                                                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€  â”‚
â”‚                                                                      â”‚
â”‚  API Call Attempt                                                    â”‚
â”‚  â”‚                                                                   â”‚
â”‚  â”œâ”€â†’ Success:                                                       â”‚
â”‚  â”‚   â””â”€â†’ Continue with processing                                    â”‚
â”‚  â”‚                                                                   â”‚
â”‚  â””â”€â†’ Error:                                                         â”‚
â”‚      â”‚                                                               â”‚
â”‚      â”œâ”€â†’ Check Error Type:                                           â”‚
â”‚      â”‚   â”‚                                                           â”‚
â”‚      â”‚   â”œâ”€â†’ API Timeout:                                            â”‚
â”‚      â”‚   â”‚   â””â”€â†’ Retry with extended timeout                         â”‚
â”‚      â”‚   â”‚                                                           â”‚
â”‚      â”‚   â”œâ”€â†’ Network Error:                                          â”‚
â”‚      â”‚   â”‚   â””â”€â†’ Retry with exponential backoff                       â”‚
â”‚      â”‚   â”‚                                                           â”‚
â”‚      â”‚   â”œâ”€â†’ Rate Limit:                                             â”‚
â”‚      â”‚   â”‚   â””â”€â†’ Wait and retry                                       â”‚
â”‚      â”‚   â”‚                                                           â”‚
â”‚      â”‚   â””â”€â†’ Other Error:                                            â”‚
â”‚      â”‚       â””â”€â†’ Log error and retry                                  â”‚
â”‚      â”‚                                                                   â”‚
â”‚      â””â”€â†’ Retry Logic:                                                â”‚
â”‚          â”œâ”€â†’ Max Attempts: 3-4                                        â”‚
â”‚          â”œâ”€â†’ Retry Delay: 5 seconds                                    â”‚
â”‚          â””â”€â†’ If all attempts fail:                                     â”‚
â”‚              â”œâ”€â†’ Mark stage as FAILED                                 â”‚
â”‚              â”œâ”€â†’ Log error details                                     â”‚
â”‚              â””â”€â†’ Continue to next stage (don't block)                  â”‚
â”‚                                                                      â”‚
â”‚  Stage Failure Handling:                                             â”‚
â”‚  â”œâ”€â†’ One stage failure doesn't stop others                             â”‚
â”‚  â”œâ”€â†’ Partial results still returned                                   â”‚
â”‚  â”œâ”€â†’ Error details logged for debugging                               â”‚
â”‚  â””â”€â†’ Summary includes partial results                                 â”‚
â”‚                                                                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Summary

These visual flow diagrams illustrate:

1. **System Architecture**: Complete component overview
2. **Multi-Stage Execution**: Sequential flow of 4 stages
3. **Parallel Enrichment**: How enrichments run in parallel per stage
4. **Data Flow**: Request/response flow through the system
5. **Retry Logic**: Error handling and retry strategy
6. **Connection Status**: How final status is determined
7. **Domain Analysis**: Domain search and confidence scoring flow
8. **Error Handling**: Comprehensive error handling strategy

---

**Use these diagrams during your deep dive call for visual reference!** ğŸ“Š


